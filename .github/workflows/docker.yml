name: 🚀 Docker CI/CD Pipeline
on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  docker:
    runs-on: self-hosted
    steps:
    - uses: actions/checkout@v4
    
    - name: 🟢 Check Node.js
      run: node --version || winget install OpenJS.NodeJS.LTS -e -s winget
      
    - name: 🔵 NPM Install
      run: npm ci --only=production
      
    - name: 🟡 Docker Build & Test
      run: |
        docker build -t devops-app:latest .
        docker run --rm devops-app:latest curl -f http://localhost:3000/health || exit 1
        
    - name: 🚀 Docker Deploy
      run: |
        docker stop devops-app 2>nul || true
        docker rm devops-app 2>nul || true
        docker run -d -p 3000:3000 --name devops-app --restart always devops-app:latest
        
    - name: ✅ Health Check
      run: |
        sleep 5
        Invoke-WebRequest -Uri http://localhost:3000 -UseBasicParsing | Select-Object StatusCode
        Invoke-WebRequest -Uri http://localhost:3000/health -UseBasicParsing | ConvertFrom-Json
